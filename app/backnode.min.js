var BackNode=function(a){this.file=null,this.iframe=a,this.document=a.contentDocument,this.editor.parent=this,this.baliseSearch.parent=this,this.ckeditor={},this.gitPath=null,this.fileSaved=[]};BackNode.prototype.explorer={pick:function(a,b){$("#dark-bgr").show(),cloudExplorer.pick({},function(c){$(window).resize(),b||$("#dark-bgr").hide(),a(c)})},save:function(a){a=a||function(){};var b=$("iframe")[0].contentDocument,c=new XMLSerializer,d=c.serializeToString(b);cloudExplorer.write(backNode.file,d,function(){-1===this.fileSaved.indexOf(this.iframe.src)&&this.fileSaved.push(this.iframe.src.replace("http://"+window.location.host+"/api/v1.0/dropbox/exec/get/","")),a()}.bind(this))}},BackNode.prototype.git={search:function(a,b,c){this.git.path=null,this.git.deployButton||(this.git.deployButton=c,this.git.deployButton.on("click",this.git.showDeployWindow.bind(this)),$("#deployModalButton").on("click",this.git.deploy.bind(this)),$("#deployGitModalButton").on("click",this.git.showDeploySaved.bind(this)));var d=a.replace("../api/v1.0/dropbox/exec/get/","").replace(b,"");$.get("/deploy/searchGit",{path:d},function(a){var b=JSON.parse(a);b.git&&(this.git.path=b.git,this.git.deployButton&&this.git.deployButton.show())}.bind(this))},showDeployWindow:function(){$(".modal-body #chooseFiles").hide(),$("#deployOnGoing textarea").hide().html(""),$(".modal-body #deployOnGoing").show(),$("#deployModalButton").show(),$(".modal-body #deployOnGoing p").show(),$("#deployGitModalButton").removeClass("disabled"),$("#deployModalButton").addClass("disabled"),$.get("/deploy/scan",{path:this.git.path},function(a){this.git.deployKey=JSON.parse(a).deployKey,this.git.socket||(this.git.socket=io.connect("http://"+window.location.hostname)),this.git.socket.on(this.git.deployKey,this.git.getDeployStatus.bind(this))}.bind(this)),this.git.getToken.bind(this)(),$(".modal").modal("show"),this.git.state="homeDeploy"},showDeploySaved:function(){if(""!==$(".modal-body #chooseFiles").html())$(".modal-body #chooseFiles").html(""),$(".modal-body #deployOnGoing p").hide(),$(".modal-body #deployOnGoing").show(),this.git.deployJustGit.bind(this)();else{var a="<div class='checkbox'><label><input type='checkbox' name='TO_REPLACE' checked> TO_REPLACE </label></div>";if($(".modal-body #chooseFiles").show(),$(".modal-body #deployOnGoing").hide(),$("#deployModalButton").hide(),$(".modal-title").html("Please select some files to deploy"),$("#deployGitModalButton").addClass("disabled"),this.fileSaved.length>0){for(var b in this.fileSaved)this.fileSaved.hasOwnProperty(b)&&$(".modal-body #chooseFiles").append(a.replace(/TO_REPLACE/g,this.fileSaved[b]));$("#deployGitModalButton").removeClass("disabled")}else $(".modal-body #chooseFiles").append("You haven't save any files, so nothing to deploy..."),$("#deployGitModalButton").addClass("disabled")}},deploy:function(){"pending"===this.git.access_token?this.git.getToken.bind(this)(this.git.deploy.bind(this)):this.git.access_token?($("#deployModalButton").addClass("disabled"),$("#deployGitModalButton").addClass("disabled"),$(".modal-body #deployOnGoing p").hide(),$.get("/deploy/all",{path:this.git.path,deployKey:this.git.deployKey}),this.git.state="deployStarted"):(window.open("https://github.com/login/oauth/authorize?redirect_uri=http://localhost:8080/gitOauth/&scope=repo&client_id=79b7bd5afe5787355123&state="+Date.now(),"_blank","width=1150,height=750"),this.git.access_token="pending")},deployJustGit:function(){var a=[],b=this;$(".modal-body #chooseFiles input").each(function(){this.checked&&(b.fileSaved.splice(b.fileSaved.indexOf(this.name),1),a.push(this.name))}),$("#deployModalButton").addClass("disabled"),$("#deployGitModalButton").addClass("disabled"),$.get("/deploy/git",{path:this.git.path,deployKey:this.git.deployKey,files:a})},getDeployStatus:function(a){"downloadFinish"===this.git.state?($("#deployOnGoing textarea").show(),$("#deployOnGoing textarea").append("\n"),$("#deployOnGoing textarea").append(a.code.replace(/</g,"&lt;").replace(/>/g,"&gt;")),"start to update git project status on your dropbox folder"===a.code&&($("#deployOnGoing .progress span").html("start to update git project status on your dropbox folder"),$("#deployOnGoing textarea").hide(),this.git.state=a.code)):$("#deployOnGoing .progress span").html(a.code),0===a.code.indexOf("total files")&&(this.git.state="scanFinish",$("#deployModalButton").removeClass("disabled"),$("#deployModalButton").html("Deploy folder ("+a.code.split("estimate duration: ")[1]+")")),0===a.code.indexOf("download finished")&&(this.git.state="downloadFinish",$("#deployOnGoing .progress span").html("deploy on going, please wait..."))},getToken:function(a){$.get("/gitOauth",null,function(b){var c=JSON.parse(b);c.access_token&&(this.git.access_token=c.access_token),a&&a(c.access_token)}.bind(this))}},BackNode.prototype.editor={editable:function(a,b){var c=this.parent,d=c.document,e=c.iframe.contentWindow;if(b===!0){for(var f in a){switch(a[f].tagName){case"IMG":$(a[f]).click(c.editor.editPicture.bind(this,$(a[f])));break;default:$(a[f]).length>0&&$(a[f]).attr("contenteditable","true")}$(a[f]).addClass("hoverEditable")}c.ckeditor.css||(c.ckeditor.css=$("<style>.hoverEditable:hover { outline: 1px dashed #7DBEFF; cursor: pointer}</style>"),$(d.head).append(c.ckeditor.css)),e.CKEDITOR.inlineAll()}else{$(c.document).find("#bn-popinPicture").remove();for(var g in a)"IMG"===a[g].tagName?$(a[g]).unbind("click"):$(a[g]).removeAttr("contenteditable"),$(a[g]).removeClass("hoverEditable");c.ckeditor.css&&(c.ckeditor.css.remove(),c.ckeditor.css=null);for(var h in e.CKEDITOR.instances)e.CKEDITOR.instances.hasOwnProperty(h)&&e.CKEDITOR.instances[h].destroy();var i=c.document.head.getElementsByTagName("style");for(var j in i)i.hasOwnProperty(j)&&""===i[j].innerHTML&&c.document.head.removeChild(i[j])}},addCkeditor:function(a){var b=a.createElement("script");b.src="/app/ckeditor/ckeditor.js",a.body.appendChild(b)},cleanCkeditor:function(a){this.cleanRessource(a,"script",["app/ckeditor/config.js","app/ckeditor/lang/","app/ckeditor/styles.js","app/ckeditor/ckeditor.js"]),this.cleanRessource(a,"link",["app/ckeditor/skins/moono/editor.css"]),this.cleanRessource(a,"style",[".cke{visibility:hidden;}"]),a.getElementsByTagName("html")[0].className=a.getElementsByTagName("html")[0].className.replace(" js canvas canvastext no-touch rgba backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations cssgradients csstransforms csstransforms3d csstransitions fontface","")},cleanRessource:function(a,b,c){var d=[];for(var e in a.getElementsByTagName(b))d.push(a.getElementsByTagName(b)[e]);for(var f=d.length,g=0;f>=g;g++)if(d[g]&&d[g].tagName){var h=d[g].src||d[g].href||d[g].innerHTML;for(var i in c)c.hasOwnProperty(i)&&-1!==h.indexOf(c[i])&&d[g].parentNode.removeChild(d[g])}},editPicture:function(a){var b=$(this.parent.document),c='<div id="bn-popinPicture" style="display:none;position:fixed;z-index:10200;width:100%;height:100%;top:0;left:0;background:#000;background:rgba(0,0,0,0.8)"></div>',d=a.attr("alt");backNode.editingPicture=a,void 0===d&&(d="");var e='<div name="bn-picForm" style="border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px;box-shadow:2px 2px 1px #000;width:410px;height:200px;text-align:center;background:#eee;position:absolute;left:50%;top:50%;margin:-100px 0 0 -205px;color:#000000;"><div style="padding:5px;margin-top:10px;margin-bottom:10px;color:#000;display:block;text-align:center"><img src="'+window.document.URL+'img/import-title.png" alt="Import your file" style="width:50%;" /><span style="cursor:pointer;position:absolute;top:-15px;right:-15px;"><img src="'+window.document.URL+'img/close-pic.png" alt="X" /></span></div><div style="height:35px;overflow:hidden;line-height:35px;margin-left:10px;"><label for="bn-picSrc" style="height:100%;float:left;margin-right:10px;">Src attribute</label><input id="bn-picSrc" type="text" name="picSrc" placeholder="Url" value="'+a.attr("src")+'" style="border:1px solid #ccc;padding-left:5px;box-sizing:border-box;height:100%;float:left;margin-right:0;border-radius:3px 0 0 3px;" /><img id="bn-picUpload" src="'+window.document.URL+'img/import-btn.png" alt="Import a file" style="height:100%;float:left;" /></div><div style="height:35px;overflow:hidden;line-height:35px;margin:10px 0 0 10px;"><label for="bn-picAlt" style="height:100%;float:left;margin-right:10px;">Alt attribute</label><input id="bn-picAlt" type="text" name="picAlt" placeholder="Alternative text" value="'+d+'" style="border:1px solid #ccc;width:290px;padding-left:5px;box-sizing:border-box;border-radius:3px;height:100%;float:left;margin-left:2px;" /></div><button id="bn-valid" style="border:0;background:#38b396;margin-top:10px;width:90%;text-align:center;font-weight:bold;color:#fff;text-transform:capitalize;border-radius:3px;line-height:35px;">Save</button></div>';b.find("body").append(c),b.find("#bn-popinPicture").append(e),b.find("#bn-popinPicture").slideDown(400,function(){b.find("#bn-popinPicture div #bn-valid").click(function(c){c.preventDefault(),a.attr("src",b.find("#bn-picSrc").val()),a.attr("alt",b.find("#bn-picAlt").val()),b.find("#bn-popinPicture").slideUp(400,function(){b.find("#bn-popinPicture").remove()})}),b.find("#bn-popinPicture div div span").click(function(){b.find("#bn-popinPicture").slideUp(400,function(){b.find("#bn-popinPicture").remove()})})})}},BackNode.prototype.baliseSearch={getList:function(a){var b=[];return b=b.concat(this.getListForSelector(a,'[data-bn="text"]','[data-bn="image"]','[data-bn="template"]','[data-bn="repeat"]')).concat(this.getListForSelector(a,".backnode-text",".backnode-image",".backnode-template",".backnode-repeat"))},getListForSelector:function(a,b,c,d,e){var f=[];return $(a).find(c+", "+b+", "+d+", "+e).each(function(){if($(this).parents(d+", "+e).size()>0)return void console.warn("getListForSelector this has a parent which is a template",this);if($(this).is(d)){var a={type:"template",DOM:this,repeats:[]};$(this).find(e).each(function(){var c={type:"repeat",DOM:this,edit:[]};$(this).find(b).each(function(){c.edit.push(this)}),a.repeats.push(c)}),f.push(a)}else f.push($(this).is(c)?$(this).get(0):this)}),f}};
//# sourceMappingURL=backnode.min.map