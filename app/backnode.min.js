var BackNode=function(a){this.file=null,this.iframe=a,this.document=a.contentDocument,this.editor.parent=this,this.baliseSearch.parent=this,this.ckeditor={},this.gitPath=null,this.fileSaved=[]};BackNode.prototype.explorer={pick:function(a,b){$("#dark-bgr").show(),cloudExplorer.pick({},function(c){$(window).resize(),b||$("#dark-bgr").hide(),a(c)})},save:function(a){a=a||function(){};var b=$("iframe")[0].contentDocument,c=new XMLSerializer,d=c.serializeToString(b);cloudExplorer.write(backNode.file,d,function(){-1===this.fileSaved.indexOf(this.iframe.src)&&this.fileSaved.push(this.iframe.src.replace("http://"+window.location.host+"/api/v1.0/dropbox/exec/get/","")),a()}.bind(this))}},BackNode.prototype.git={STATES:{INIT:1,GO_DEPLOY:2,DEPLOY:3,DOWNLOAD_FINISH:4,SCAN_FINISH:5},getUI:function(){this.git.ui={container:$(".modal"),progressBar:$("#deployOnGoing .progress"),progressBarCurrent:$("#deployOnGoing .progress-bar"),btDeploy:$("#deployModalButton"),btDeployGit:$("#deployGitModalButton"),btCreate:$("#chooseProjectFolder button"),inputCreate:$("#chooseProjectFolder input"),boxChooseFile:$(".modal-body #chooseFiles"),boxCreate:$("#chooseProjectFolder"),boxDeploy:$(".modal-body #deployOnGoing"),textDeploy:$("#deployOnGoing textarea"),textManGit:$(".modal-body #deployOnGoing p"),textGitHubPageUrl:$("#deployOnGoing center"),textProgressBar:$("#deployOnGoing .progress span"),textUserProfile:$("#userProfile h4"),imageUserProfile:$("#userProfile img"),templateCB:"<div class='checkbox'><label><input type='checkbox' name='TO_REPLACE' checked> TO_REPLACE </label></div>"}},search:function(a,b){this.git.path=null,this.git.ui||this.git.getUI.bind(this)(),this.git.deployButton||(this.git.deployButton=b,this.git.deployButton.on("click",this.git.showDeployWindow.bind(this)),this.git.ui.btDeploy.on("click",this.git.deploy.bind(this)),this.git.ui.btDeployGit.on("click",this.git.showDeploySaved.bind(this)),this.git.ui.btCreate.on("click",this.git.createRepo.bind(this))),this.git.dropboxPath=a,$.get("/deploy/searchGit",{path:this.git.dropboxPath},function(a){var b=JSON.parse(a);b.git?(this.git.path=b.git,this.git.state=this.git.STATES.GO_DEPLOY,this.git.deployButton.html(this.git.deployButton.html().replace("Init","Deploy"))):(this.git.state=this.git.STATES.INIT,this.git.deployButton.html(this.git.deployButton.html().replace("Deploy","Init"))),this.git.deployButton.show(),this.git.getToken.bind(this)(),$.get("/conf/gitAppId.json",null,function(a){a.client_id&&a.client_secret&&a.client_redirect?this.git.appId=a:window.console.warn("In order to use git plugin, you must fill your app info on file /app/conf/gitAppId.js")}.bind(this))}.bind(this))},showDeployWindow:function(){this.git.access_token?"pending"===this.git.access_token?this.git.getToken.bind(this)(this.git.showDeployWindow.bind(this)):(this.git.ui.boxChooseFile.hide(),this.git.ui.boxCreate.hide(),this.git.ui.textDeploy.hide().html(""),this.git.ui.boxDeploy.show(),this.git.ui.btDeploy.show(),this.git.ui.textManGit.show(),this.git.ui.btDeployGit.removeClass("disabled"),this.git.ui.btDeploy.addClass("disabled"),this.git.ui.textGitHubPageUrl.hide(),this.git.ui.progressBar.show(),this.git.ui.progressBarCurrent.get(0).className="progress-bar",this.git.ui.progressBar.get(0).className="progress progress-striped active",this.git.ui.container.modal("show"),this.git.state===this.git.STATES.INIT?(this.git.ui.boxCreate.show(),this.git.ui.progressBar.hide(),this.git.ui.inputCreate.attr("value",this.git.dropboxPath)):($.get("/deploy/scanFolder",{path:this.git.path},function(a){this.git.deployKey=JSON.parse(a).deployKey,this.git.socket||(this.git.socket=io.connect("http://"+window.location.hostname)),this.git.socket.on(this.git.deployKey,this.git.getDeployStatus.bind(this))}.bind(this)),this.git.state=this.git.STATES.DEPLOY)):(window.open("https://github.com/login/oauth/authorize?redirect_uri="+this.git.appId.client_redirect+"/gitOauth/&scope=repo&client_id="+this.git.appId.client_id+"&state="+Date.now(),"_blank","width=1150,height=750"),this.git.access_token="pending")},showDeploySaved:function(){if(""!==this.git.ui.boxChooseFile.html())this.git.ui.boxChooseFile.html(""),this.git.ui.textManGit.hide(),this.git.ui.boxDeploy.show(),this.git.deployJustGit.bind(this)();else if(this.git.ui.boxChooseFile.show(),this.git.ui.boxDeploy.hide(),this.git.ui.btDeploy.hide(),this.git.ui.btDeployGit.addClass("disabled"),this.fileSaved.length>0){for(var a in this.fileSaved)this.fileSaved.hasOwnProperty(a)&&this.git.ui.boxChooseFile.append(this.git.ui.templateCB.replace(/TO_REPLACE/g,this.fileSaved[a]));this.git.ui.btDeployGit.removeClass("disabled")}else this.git.ui.boxChooseFile.append("You haven't save any files, so nothing to deploy..."),this.git.ui.btDeployGit.addClass("disabled")},deploy:function(){this.git.access_token&&(this.git.ui.btDeploy.addClass("disabled"),this.git.ui.btDeployGit.addClass("disabled"),this.git.ui.textManGit.hide(),$.get("/deploy/deployFolder",{path:this.git.path,deployKey:this.git.deployKey,initOnUrl:this.git.initOnUrl||"",accessToken:this.git.access_token}),this.git.initOnUrl="",this.git.state=this.git.STATES.DEPLOY)},deployJustGit:function(){var a=[],b=this;$(".modal-body #chooseFiles input").each(function(){this.checked&&(b.fileSaved.splice(b.fileSaved.indexOf(this.name),1),a.push(this.name))}),this.git.ui.btDeploy.addClass("disabled"),this.git.ui.btDeployGit.addClass("disabled"),$.get("/deploy/grabGit",{path:this.git.path,deployKey:this.git.deployKey,files:a})},getDeployStatus:function(a){if(this.git.state===this.git.STATES.DOWNLOAD_FINISH)this.git.ui.textDeploy.show(),this.git.ui.textDeploy.append("\n"),this.git.ui.textDeploy.append(a.code.replace(/</g,"&lt;").replace(/>/g,"&gt;")),"update git project status on your dropbox folder..."===a.code&&(this.git.ui.textProgressBar.html(a.code),this.git.ui.textDeploy.hide(),this.git.state=a.code);else if(0===a.code.indexOf("http://"))this.git.ui.textGitHubPageUrl.show(),this.git.ui.textGitHubPageUrl.html("<a href='"+a.code+"' target='_blank'>"+a.code+"</a>"),this.git.ui.textProgressBar.append("   <i class='fa fa-check-square-o'></i>"),this.git.ui.progressBarCurrent.get(0).className="progress-bar progress-bar-success",this.git.ui.progressBar.get(0).className="progress";else if(0===a.code.indexOf("files found:"))0===a.code.indexOf("files found: 1")&&this.git.ui.textProgressBar.html("scanning your folder <i class='fa fa-refresh fa-spin'></i>");else if(0===a.code.indexOf("total files"))this.git.state=this.git.STATES.SCAN_FINISH,this.git.ui.btDeploy.removeClass("disabled"),this.git.ui.textProgressBar.html("scan finished <i class='fa fa-check-square-o'></i>"),this.git.ui.progressBar.get(0).className="progress";else if(0===a.code.indexOf("download status:")){var b=a.code.replace("download status: ","").split("/"),c=Math.ceil(100*parseInt(b[0])/parseInt(b[1]))+"%";this.git.ui.progressBarCurrent.css("width",c),this.git.ui.textProgressBar.html(c)}else 0===a.code.indexOf("download finished")?(this.git.state=this.git.STATES.DOWNLOAD_FINISH,this.git.ui.textProgressBar.html("deploy on going, please wait..."),this.git.ui.progressBar.get(0).className="progress progress-striped active"):this.git.ui.textProgressBar.html(a.code)},createRepo:function(){$.get("/deploy/createRepo",{name:this.git.ui.inputCreate.attr("value"),accessToken:this.git.access_token},function(a){var b=JSON.parse(a);this.git.path=this.git.ui.inputCreate.attr("value"),this.git.state=this.git.STATES.GO_DEPLOY,this.git.initOnUrl=b.repoUrl,this.git.showDeployWindow.bind(this)(),this.git.deployButton.html(this.git.deployButton.html().replace("Init","Deploy"))}.bind(this))},getToken:function(a){$.get("/gitOauth",null,function(b){var c=JSON.parse(b);c.access_token&&(this.git.access_token=c.access_token,this.git.user_infos||$.get("/deploy/userInfos",{accessToken:c.access_token},function(a){var b=JSON.parse(a);b.data&&(this.git.user_infos=b.data,this.git.updateProfile.bind(this,b.data.avatar_url,b.data.login||b.data.name)())}.bind(this))),a&&a(c.access_token)}.bind(this))},updateProfile:function(a,b){this.git.ui.imageUserProfile.attr("src",a||"http://i2.wp.com/assets-cdn.github.com/images/gravatars/gravatar-user-420.png"),this.git.ui.textUserProfile.html(b||"Login")}},BackNode.prototype.editor={editable:function(a,b){var c=this.parent,d=c.document,e=c.iframe.contentWindow;if(b===!0){for(var f in a){switch(a[f].tagName){case"IMG":$(a[f]).click(c.editor.editPicture.bind(this,$(a[f])));break;default:$(a[f]).length>0&&$(a[f]).attr("contenteditable","true")}$(a[f]).addClass("hoverEditable")}c.ckeditor.css||(c.ckeditor.css=$("<style>.hoverEditable:hover { outline: 1px dashed #7DBEFF; cursor: pointer}</style>"),$(d.head).append(c.ckeditor.css)),e.CKEDITOR.inlineAll()}else{$(c.document).find("#bn-popinPicture").remove();for(var g in a)"IMG"===a[g].tagName?$(a[g]).unbind("click"):$(a[g]).removeAttr("contenteditable"),$(a[g]).removeClass("hoverEditable");c.ckeditor.css&&(c.ckeditor.css.remove(),c.ckeditor.css=null);for(var h in e.CKEDITOR.instances)e.CKEDITOR.instances.hasOwnProperty(h)&&e.CKEDITOR.instances[h].destroy();var i=c.document.head.getElementsByTagName("style");for(var j in i)i.hasOwnProperty(j)&&""===i[j].innerHTML&&c.document.head.removeChild(i[j])}},addCkeditor:function(a){var b=a.createElement("script");b.src="/app/ckeditor/ckeditor.js",a.body.appendChild(b)},cleanCkeditor:function(a){this.cleanRessource(a,"script",["app/ckeditor/config.js","app/ckeditor/lang/","app/ckeditor/styles.js","app/ckeditor/ckeditor.js"]),this.cleanRessource(a,"link",["app/ckeditor/skins/moono/editor.css"]),this.cleanRessource(a,"style",[".cke{visibility:hidden;}"]),a.getElementsByTagName("html")[0].className=a.getElementsByTagName("html")[0].className.replace(" js canvas canvastext no-touch rgba backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations cssgradients csstransforms csstransforms3d csstransitions fontface","")},cleanRessource:function(a,b,c){var d=[];for(var e in a.getElementsByTagName(b))d.push(a.getElementsByTagName(b)[e]);for(var f=d.length,g=0;f>=g;g++)if(d[g]&&d[g].tagName){var h=d[g].src||d[g].href||d[g].innerHTML;for(var i in c)c.hasOwnProperty(i)&&-1!==h.indexOf(c[i])&&d[g].parentNode.removeChild(d[g])}},editPicture:function(a){var b=$(this.parent.document),c='<div id="bn-popinPicture" style="display:none;position:fixed;z-index:10200;width:100%;height:100%;top:0;left:0;background:#000;background:rgba(0,0,0,0.8)"></div>',d=a.attr("alt");backNode.editingPicture=a,void 0===d&&(d="");var e='<div name="bn-picForm" style="border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px;box-shadow:2px 2px 1px #000;width:410px;height:200px;text-align:center;background:#eee;position:absolute;left:50%;top:50%;margin:-100px 0 0 -205px;color:#000000;"><div style="padding:5px;margin-top:10px;margin-bottom:10px;color:#000;display:block;text-align:center"><img src="'+window.document.URL+'img/import-title.png" alt="Import your file" style="width:50%;" /><span style="cursor:pointer;position:absolute;top:-15px;right:-15px;"><img src="'+window.document.URL+'img/close-pic.png" alt="X" /></span></div><div style="height:35px;overflow:hidden;line-height:35px;margin-left:10px;"><label for="bn-picSrc" style="height:100%;float:left;margin-right:10px;">Src attribute</label><input id="bn-picSrc" type="text" name="picSrc" placeholder="Url" value="'+a.attr("src")+'" style="border:1px solid #ccc;padding-left:5px;box-sizing:border-box;height:100%;float:left;margin-right:0;border-radius:3px 0 0 3px;" /><img id="bn-picUpload" src="'+window.document.URL+'img/import-btn.png" alt="Import a file" style="height:100%;float:left;" /></div><div style="height:35px;overflow:hidden;line-height:35px;margin:10px 0 0 10px;"><label for="bn-picAlt" style="height:100%;float:left;margin-right:10px;">Alt attribute</label><input id="bn-picAlt" type="text" name="picAlt" placeholder="Alternative text" value="'+d+'" style="border:1px solid #ccc;width:290px;padding-left:5px;box-sizing:border-box;border-radius:3px;height:100%;float:left;margin-left:2px;" /></div><button id="bn-valid" style="border:0;background:#38b396;margin-top:10px;width:90%;text-align:center;font-weight:bold;color:#fff;text-transform:capitalize;border-radius:3px;line-height:35px;">Save</button></div>';b.find("body").append(c),b.find("#bn-popinPicture").append(e),b.find("#bn-popinPicture").slideDown(400,function(){b.find("#bn-popinPicture div #bn-valid").click(function(c){c.preventDefault(),a.attr("src",b.find("#bn-picSrc").val()),a.attr("alt",b.find("#bn-picAlt").val()),b.find("#bn-popinPicture").slideUp(400,function(){b.find("#bn-popinPicture").remove()})}),b.find("#bn-popinPicture div div span").click(function(){b.find("#bn-popinPicture").slideUp(400,function(){b.find("#bn-popinPicture").remove()})})})}},BackNode.prototype.baliseSearch={getList:function(a){var b=[];return b=b.concat(this.getListForSelector(a,'[data-bn="text"]','[data-bn="image"]','[data-bn="template"]','[data-bn="repeat"]')).concat(this.getListForSelector(a,".backnode-text",".backnode-image",".backnode-template",".backnode-repeat"))},getListForSelector:function(a,b,c,d,e){var f=[];return $(a).find(c+", "+b+", "+d+", "+e).each(function(){if($(this).parents(d+", "+e).size()>0)return void console.warn("getListForSelector this has a parent which is a template",this);if($(this).is(d)){var a={type:"template",DOM:this,repeats:[]};$(this).find(e).each(function(){var c={type:"repeat",DOM:this,edit:[]};$(this).find(b).each(function(){c.edit.push(this)}),a.repeats.push(c)}),f.push(a)}else f.push($(this).is(c)?$(this).get(0):this)}),f}};
//# sourceMappingURL=backnode.min.map